---
title: "Generalization & transfer paper"
output: html_notebook
---


```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(grid)
library(gtable)
library(latex2exp)
```

```{r}
theme_set(theme_bw(base_size = 15) +
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))
```

```{r}
# stolen from stack exchange with minor tweaks
label_facets = function(p, label_top, label_right) {
  # Get the ggplot grob
  z <- ggplotGrob(p)
  
  # Get the positions of the strips in the gtable: t = top, l = left, ...
  posR <- subset(z$layout, grepl("strip-r", name), select = t:r)
  posT <- subset(z$layout, grepl("strip-t", name), select = t:r)
  
  # Add a new column to the right of current right strips, 
  # and a new row on top of current top strips
  width <- z$widths[max(posR$r)]    # width of current right strips
  height <- z$heights[min(posT$t)]  # height of current top strips
  
  z <- gtable_add_cols(z, width, max(posR$r))  
  z <- gtable_add_rows(z, height, min(posT$t)-1)
  
  # Construct the new strip grobs
  stripR <- gTree(name = "Strip_right", children = gList(
     rectGrob(gp = gpar(col = NA, fill = "grey85")),
     textGrob(label_right, rot = -90, gp = gpar(fontsize = 15, col = "grey10"))))
  
  stripT <- gTree(name = "Strip_top", children = gList(
     rectGrob(gp = gpar(col = NA, fill = "grey85")),
     textGrob(label_top, gp = gpar(fontsize = 15, col = "grey10"))))
  
  # Position the grobs in the gtable
  z <- gtable_add_grob(z, stripR, t = min(posR$t)+1, l = max(posR$r) + 1, b = max(posR$b)+1, name = "strip-right")
  z <- gtable_add_grob(z, stripT, t = min(posT$t), l = min(posT$l), r = max(posT$r), name = "strip-top")
  
  # Add small gaps between strips
  z <- gtable_add_cols(z, unit(1/5, "line"), max(posR$r))
  z <- gtable_add_rows(z, unit(1/5, "line"), min(posT$t))
  
  # Draw it
  grid.newpage()
  grid.draw(z)
  
  return(z)
}
```


## Assumption checks
```{r}
nruns = 5
noise_vars = c(1.)
output_sizes= c(100)
svms = 1:10
alignments = c("True", "False")
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (svm in svms) {
      for (aligned in alignments) {
        for (run in 0:(nruns-1)) { 
          this_d = read.csv(sprintf("../single_generalization_comparison_results/noise_var_%.2f_output_size_%i_svm_%f_aligned_%s_run_%i.csv",noise_var, output_size, svm, aligned, run), header=T)
    
          this_d = this_d %>% 
            mutate(noise_var=noise_var, output_size=output_size, svm=svm, aligned=aligned=="True", run=run, student_rank="Full rank", type="Empirical")
          d = bind_rows(d, this_d)
        }
      }
      this_d = read.csv(sprintf("../single_generalization_comparison_results/noise_var_%.2f_svm_%f_theory_track.csv", noise_var, svm), header=T)
    
      this_d = this_d %>% 
        rename(loss=generalization_error) %>%
        mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA, student_rank="Full rank", type="Theory")
      d = bind_rows(d, this_d)
    }
  }
}
```

```{r}
prepostfix = "rank4stud"
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (svm in svms) {
      for (aligned in alignments) {
        for (run in 0:(nruns-1)) { 
          this_d = read.csv(sprintf("../single_generalization_comparison_results_%s/noise_var_%.2f_output_size_%i_svm_%f_aligned_%s_run_%i.csv", prepostfix, noise_var, output_size, svm, aligned, run), header=T)
    
          this_d = this_d %>% 
            mutate(noise_var=noise_var, output_size=output_size, svm=svm, aligned=aligned=="True", student_rank="4% of full", run=run, type="Empirical")
          d = bind_rows(d, this_d)
        }
      }
      this_d = read.csv(sprintf("../single_generalization_comparison_results_%s/noise_var_%.2f_svm_%f_theory_track.csv", prepostfix, noise_var, svm), header=T)
    
      this_d = this_d %>% 
        rename(loss=generalization_error) %>%
        mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA,  student_rank="4% of full", type="Theory")
      d = bind_rows(d, this_d)
    }
  }
}
```

```{r}
prepostfix = "smallstud"
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (svm in svms) {
      for (aligned in alignments) {
        for (run in 0:(nruns-1)) { 
          this_d = read.csv(sprintf("../single_generalization_comparison_results_%s/noise_var_%.2f_output_size_%i_svm_%f_aligned_%s_run_%i.csv", prepostfix, noise_var, output_size, svm, aligned, run), header=T)
    
          this_d = this_d %>% 
            mutate(noise_var=noise_var, output_size=output_size, svm=svm, aligned=aligned=="True", student_rank="Teacher rank (1% of full)", run=run, type="Empirical")
          d = bind_rows(d, this_d)
        }
      }
      this_d = read.csv(sprintf("../single_generalization_comparison_results_%s/noise_var_%.2f_svm_%f_theory_track.csv", prepostfix, noise_var, svm), header=T)
    
      this_d = this_d %>% 
        rename(loss=generalization_error) %>%
        mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA,  student_rank="Teacher rank (1% of full)", type="Theory")
      d = bind_rows(d, this_d)
    }
  }
}
```

```{r}
prepostfix = "50stud"
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (svm in svms) {
      for (aligned in alignments) {
        for (run in 0:(nruns-1)) { 
          this_d = read.csv(sprintf("../single_generalization_comparison_results_%s/noise_var_%.2f_output_size_%i_svm_%f_aligned_%s_run_%i.csv", prepostfix, noise_var, output_size, svm, aligned, run), header=T)
    
          this_d = this_d %>% 
            mutate(noise_var=noise_var, output_size=output_size, svm=svm, aligned=aligned=="True", student_rank="50% of full", run=run, type="Empirical")
          d = bind_rows(d, this_d)
        }
      }
      this_d = read.csv(sprintf("../single_generalization_comparison_results_%s/noise_var_%.2f_svm_%f_theory_track.csv", prepostfix, noise_var, svm), header=T)
    
      this_d = this_d %>% 
        rename(loss=generalization_error) %>%
        mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA,  student_rank="50% of full", type="Theory")
      d = bind_rows(d, this_d)
    }
  }
}
```

```{r}
d = d %>%
  mutate(output_size=factor(output_size),
         noise_var=factor(noise_var),
         svm=factor(svm),
         aligned=factor(aligned),
         type=factor(type),
         student_rank=factor(student_rank, levels=c("Full rank", "50% of full", "4% of full", "Teacher rank (1% of full)"), labels=c("Full rank", "50% of full", "4% of full", "1% of full")),
         log_loss = log(loss))
```

```{r}
min_d = d %>%
  group_by(svm, aligned, noise_var, type, student_rank, run) %>%
  summarize(min_Eg = min(log_loss), min_t = which.min(log_loss)) %>%
  ungroup() %>%
  group_by(svm, aligned, noise_var, student_rank, type) %>%
  summarize(avg_min_Eg = mean(min_Eg), sd_min_Eg = sd(min_Eg),
            avg_min_t = mean(min_t), sd_min_t = sd(min_t),
            se_min_Eg = sd_min_Eg/sqrt(n()), ci_Eg_up= avg_min_Eg + 1.96*se_min_Eg, ci_Eg_lo= avg_min_Eg - 1.96*se_min_Eg,
            se_min_t = sd_min_t/sqrt(n()), ci_t_up= avg_min_t + 1.96*se_min_t, ci_t_lo= avg_min_t - 1.96*se_min_t) %>%
  ungroup()
  
```

```{r}
avg_d = d %>%
  group_by(noise_var, output_size, svm, aligned, epoch, student_rank, type) %>%
  summarize(loss=mean(loss), log_loss_sd=sd(log_loss), log_loss=mean(log_loss)) %>%
  mutate(log_loss_95_low=log_loss-1.96*log_loss_sd/sqrt(n()), log_loss_95_high=log_loss+1.96*log_loss_sd/sqrt(n())) %>%
  ungroup() %>%
  mutate(new_type = ifelse(type == "Theory", "Theory",
                            ifelse(aligned == "TRUE", "Empirical aligned", "Empirical random"))) %>%
  mutate(new_type = factor(new_type, levels=c("Theory", "Empirical aligned", "Empirical random")))
```


```{r}
# ggplot(avg_d, aes(x=epoch, y=log_loss, color=as.numeric(svm), shape=student_rank, group=interaction(new_type, svm, student_rank))) +
#   geom_line(size=1.2) +
# #  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
#   scale_color_gradient(low="#0000FF", high="#FF0000") +
#   ylab("Log generalization loss") +
#   xlab("Epoch") +
#   guides(color=guide_colorbar(title="SNR"), linetype=guide_legend(title="Theory or empirical"))
```

```{r}
# ggsave(sprintf("../plots/%s_theory_empirical_alignment.png", prepostfix))
```
```{r}
wide_min_d = min_d %>% 
  filter(type == "Empirical") %>%
  select(-type, -se_min_Eg, -se_min_t) %>%
  gather(metric, measurement, avg_min_Eg, sd_min_Eg, avg_min_t, sd_min_t, ci_t_up, ci_t_lo, ci_Eg_up, ci_Eg_lo) %>%
  mutate(aligned = ifelse(aligned=="TRUE", "Aligned", "Random")) %>%
  unite(am, aligned, metric) %>%
  spread(am, measurement) %>%
  filter(svm != 1)
```


```{r}
ggplot(data=wide_min_d, aes(x=Aligned_avg_min_Eg, y=Random_avg_min_Eg, shape=student_rank, color=as.numeric(svm))) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(1, 10), breaks=c(1, 10))  +
  geom_abline(aes(intercept=0, slope=1), alpha=0.5, linetype=3) +
  labs(x="Min log generalization error (aligned init.)",
       y="Min log generalization error (random init.)") +
  geom_point(size=2) +
  geom_errorbar(aes(ymin=Random_ci_Eg_lo, ymax=Random_ci_Eg_up), width=0.05) +
  geom_errorbarh(aes(xmin=Aligned_ci_Eg_lo, xmax=Aligned_ci_Eg_up), height=0.05) +
  guides(color=F, shape=F)
```

```{r}
ggsave("../plots/paper/min_Eg_aligned_vs_random.png", width=5, height=5)
```

```{r}

```


```{r}
ggplot(data=wide_min_d, aes(x=Aligned_avg_min_t, y=Random_avg_min_t, shape=student_rank, color=as.integer(svm))) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(1, 10), breaks=c(1,10))  +
  geom_abline(aes(intercept=0, slope=1), alpha=0.5, linetype=3) +
  labs(x="Optimal stopping epoch (aligned init.)",
       y="Optimal stopping epoch (random init.)") +
  geom_point(size=2) +
  geom_errorbar(aes(ymin=Random_ci_t_lo, ymax=Random_ci_t_up), width=5) +
  geom_errorbarh(aes(xmin=Aligned_ci_t_lo, xmax=Aligned_ci_t_up), height=5) +
  xlim(200, 800) + 
  ylim(200, 800) +
  guides(shape=guide_legend(title="Empirical results", order=2), color=guide_colorbar(title="SNR", order=1))
```

```{r}
ggsave("../plots/paper/min_t_aligned_vs_random.png", width=7, height=5)
```

```{r}
min_d2 = min_d %>% 
  mutate(this_type=ifelse(type=="Theory", "Theory",
                          ifelse(aligned == "TRUE", "Empirical-aligned", "Empirical-random"))) %>%
  select(-type, -aligned, -se_min_Eg, -se_min_t) 
```

```{r}
ggplot(data=min_d2 %>% filter(this_type=="Empirical-aligned", svm != 1), aes(x=avg_min_t, y=avg_min_Eg, color=as.integer(svm), shape=student_rank)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(1, 10), breaks=c(1,10))  +
#  geom_abline(aes(intercept=0, slope=1), alpha=0.5, linetype=3) +
  geom_line(data= min_d2 %>% filter(this_type=="Theory", svm != 1), aes(group=student_rank, linetype=this_type))+ 
  labs(x="Optimal stopping epoch",
       y="Best log generalization error") +
  geom_point(size=2) +
#  geom_errorbar(aes(ymin=ci_Eg_lo, ymax=ci_Eg_up), width=7) +
#  geom_errorbarh(aes(xmin=ci_t_lo, xmax=ci_t_up), height=0.05) +
  ylim(-4, 0) +
  xlim(150, 800) +
  guides(shape=guide_legend(title="Empirical results", order=2), color=guide_colorbar(title="SNR", order=1), linetype=guide_legend(title="", order=3))
```

```{r}
ggsave("../plots/paper/aligned_min_Eg_vs_min_t.png", width=7, height=5)
```


```{r}
ggplot(data=min_d2 %>% filter(this_type=="Empirical-random", svm != 1), aes(x=avg_min_t, y=avg_min_Eg, color=as.integer(svm), shape=student_rank)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(1, 10), breaks=c(1,10))  +
#  geom_abline(aes(intercept=0, slope=1), alpha=0.5, linetype=3) +
#  geom_line(data= min_d2 %>% filter(this_type=="Theory", svm != 1), aes(group=student_rank, linetype=this_type))+ 
  labs(x="Optimal stopping epoch",
       y="Best log generalization error") +
  geom_point(size=2) +
#  geom_errorbar(aes(ymin=ci_Eg_lo, ymax=ci_Eg_up), width=7) +
#  geom_errorbarh(aes(xmin=ci_t_lo, xmax=ci_t_up), height=0.05) +
  ylim(-4, 0) +
  xlim(150, 800) +
  guides(color=F, shape=F)
```

```{r}
ggsave("../plots/paper/random_min_Eg_vs_min_t.png", width=5, height=5)
```

# Figure one: Saxe et al curves

```{r}
da = read.csv("../figure_stuff/s_of_t_a.csv", sep=",", header=T) 
db = read.csv("../figure_stuff/s_of_t_b.csv", sep=",", header=T) 
```

```{r}
p = ggplot(da %>% filter(t <= 5), aes(x=t, y=s_of_t, color=s_hat, group=s_hat)) +
  annotate("segment", y = 4, yend=4, x=0, xend=5, alpha=0.5, linetype=2, size=1, color="#AD00AF") +
  annotate("segment", y = 0, yend=10, x=1.036, xend=1.036, alpha=0.5, linetype=2, size=1, color="#AD00AF") +
  geom_line(size=2) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(1, 10), breaks=c(1,4,7,10))  +
  scale_x_continuous(breaks =c(0, 1.036, 5), labels=c("0", parse(text="t[4]"), "5")) +
  scale_y_continuous(breaks =c(0, 4, 10)) +
  coord_cartesian(xlim=c(0,5), ylim=c(0,10)) +
  labs(x=parse(text="t/tau"), y=parse(text="s(t, hat(s))")) +
  guides(color=guide_legend(title=parse(text="hat(s)")))  +
  annotation_custom(textGrob(label = "A", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      )

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt) 
```

colors: "#0000FF" "#AD00AF" "#DF0063" "#FF0000"
```{r}
ggsave("../plots/paper/fig_1a.png", plot=gt, width=4, height=3)
```

```{r}
p = ggplot(db %>% filter(t <= 4), aes(x=s_hat, y=s_of_t/s_hat, color=t, group=t)) +
#  annotate("segment", y = 4, yend=4, x=-1, xend=6, alpha=0.5, linetype=2, size=1, color="#AD00AF") +
#  annotate("segment", y = -1, yend=11, x=1.036, xend=1.036, alpha=0.5, linetype=2, size=1, color="#AD00AF") +
  annotate("segment", y=1.12, yend=1.12, x=7, size=1.25, xend=4, arrow=arrow(length=unit(0.075, "inches")), color="#999999") +
  annotate("text", x=7.25, y= 1.13, label="t", size=8, color="#999999") + 
  geom_line(size=2) +
  scale_color_gradient(low="#AA00CC", high="#CCCC00", limits=c(0.5, 4), breaks=c(0.5, 1:4))  +
  scale_x_continuous(breaks =c(0, 4, 7, 10)) +
  scale_y_continuous(breaks =c(0, 1)) +
  coord_cartesian(xlim=c(0,10), ylim=c(0,1.2)) +
  labs(x=parse(text="hat(s)"), y=parse(text="s(t, hat(s))/hat(s)")) +
  guides(color=guide_legend(title=parse(text="t/tau"))) +
  annotation_custom(textGrob(label = "B", hjust = 2, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      )

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/fig_1b.png", plot=gt, width=4, height=3)
```

# Figure 2
```{r}
d = read.csv("../figure_stuff/figure_2b_half.csv", header=T) %>%
  mutate(obsv_S_hat = ifelse(obsv_S_hat > 0, ifelse(sbar > 2.5, obsv_S_hat*5, obsv_S_hat), NA),
         pred_MP_S_hat = ifelse(sbar < 2., pred_MP_S_hat, NA),
         sbar_sig = ifelse(pred_sig_S_hat > 0, sbar, NA))
```

```{r}
p = ggplot(data=d, aes(x=sbar)) +
  geom_bar(aes(y=obsv_S_hat, fill="#1B9E77"), stat="identity") +
  geom_vline(aes(xintercept=sbar_sig, color="#D95F02"), linetype=2, size=1.1) +
  geom_line(aes(x=sbar-0.1, y=pred_MP_S_hat, color="#7570B3"), size=1.1, linetype=2) + # because points are left edge of bin, shift by half binwidth
  scale_fill_identity(name="Empirical", guide="legend", labels=c("Empirical")) +
  scale_color_identity(name="Theoretical", guide="legend", breaks=c("#D95F02", "#7570B3"), labels=c("Signal", "Noise")) +
  scale_x_continuous(breaks=c(0., 8.)) +
  labs(x=parse(text="bar(s)"), y="Count")+
  annotation_custom(textGrob(label = "A", hjust = 2.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      )

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/fig_2a.png", plot=gt, width=6, height=3)
```


```{r}
d = read.csv("../figure_stuff/figure_2b.csv", header=T) %>%
  mutate(obsv_S_hat = ifelse(obsv_S_hat > 0, ifelse(sbar > 2.5, obsv_S_hat*5, obsv_S_hat), NA),
         pred_MP_S_hat = ifelse(sbar < 2., pred_MP_S_hat, NA),
         sbar_sig = ifelse(pred_sig_S_hat > 0, sbar, NA))
```

```{r}
p = ggplot(data=d, aes(x=sbar)) +
  geom_bar(aes(y=obsv_S_hat, fill="#1B9E77"), stat="identity") +
  geom_vline(aes(xintercept=sbar_sig, color="#D95F02"), linetype=2, size=1.1) +
  geom_line(aes(x=sbar, y=pred_MP_S_hat, color="#7570B3"), size=1.1, linetype=2) + 
  scale_fill_identity(name="Empirical", guide="legend", labels=c("Empirical")) +
  scale_color_identity(name="Theoretical", guide="legend", breaks=c("#D95F02", "#7570B3"), labels=c("Signal", "Noise")) +
  scale_x_continuous(breaks=c(0., 8.)) +
  labs(x=parse(text="bar(s)"), y="Count")+
  annotation_custom(textGrob(label = "A", hjust = 2.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      )

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/fig_2b.png", plot=gt, width=4, height=3)
```

```{r}
d = read.csv("../figure_stuff/figure_2c.csv", header=T) %>%
  mutate(S_emp_mean = ifelse(S_emp_se >= 0, S_emp_mean, NA),
         S_emp_se = ifelse(S_emp_se >= 0, S_emp_se, NA))
```

```{r}
p = ggplot(d %>% filter(sbar <= 5.), aes(x=sbar, y=S_hat, color=factor(A), group=A)) +
  geom_line(aes(linetype=factor("Theory")), size=2) +
  geom_errorbar(aes(ymin=S_emp_mean-1.96*S_emp_se,
                    ymax=S_emp_mean+1.96*S_emp_se))+
  geom_point(aes(y=S_emp_mean, shape=factor("Empirical")), size=3) +
  scale_color_manual(values=c("#A1D99B", "#41AB5D", "#238B45", "#00441B"), breaks=c(0.25,0.5,0.75,1.)) +
  coord_cartesian(ylim=c(0,5), xlim=c(0,5)) +
  scale_x_continuous(breaks=c(0, 2.5, 5)) +
  labs(x=parse(text="bar(s)"), y= parse(text="hat(s)")) +
  guides(color=guide_legend(title="A", order=1),
         linetype=guide_legend(title="", order=2),
         shape=guide_legend(title="")) +
  geom_abline(aes(intercept=0, slope=1), alpha=0.5, linetype=3, size=2) +
  annotation_custom(textGrob(label = "B", hjust = 2, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      )+ 
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/fig_2c.png", plot=gt, width=4, height=3)
```

## figure 2d
```{r}
d = read.csv("../figure_stuff/figure_2d.csv", header=T)
```

```{r}
d = d %>% 
  mutate(C_emp_mean=ifelse(C_emp_se <0, NA, C_emp_mean),
         C_emp_se=ifelse(C_emp_se <0, NA, C_emp_se))
```

```{r}
p = ggplot(d %>% filter(sbar <= 5.), aes(x=sbar, y=C, color=factor(A), group=A)) +
  geom_line(size=2) +
  geom_errorbar(aes(ymin = C_emp_mean - 1.96*C_emp_se, ymax=C_emp_mean + 1.96 * C_emp_se)) +
  geom_point(aes(y=C_emp_mean), size=3) +
  scale_color_manual(values=c("#A1D99B", "#41AB5D", "#238B45", "#00441B"), breaks=c(0.25,0.5,0.75,1.)) +
  coord_cartesian(ylim=c(0,1), xlim=c(0,5)) +
  scale_x_continuous(breaks=c(0, 2.5, 5)) +
  labs(x=parse(text="bar(s)"), y= parse(text="Overlap")) +
  guides(color=F) +
  annotation_custom(textGrob(label = "C", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) 


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/fig_2d.png", plot=gt, width=3, height=3)
```
# Approximating min generalization error with only components out of the noise and misalignment

```{r}
approx_min_d = bind_rows(
  read.csv("../single_generalization_comparison_results/min_gen_approx.csv") %>%
    mutate(student_rank="Full rank"),
  read.csv("../single_generalization_comparison_results_rank4stud/min_gen_approx.csv") %>%
    mutate(student_rank="4% of full"),
  read.csv("../single_generalization_comparison_results_50stud/min_gen_approx.csv") %>%
    mutate(student_rank="50% of full"),
  read.csv("../single_generalization_comparison_results_smallstud/min_gen_approx.csv") %>%
    mutate(student_rank="Teacher rank (1% of full)"))

```

```{r}
approx_min_d = approx_min_d %>% 
  rename(svm=singular_value_multiplier) %>%
  mutate(approx_log_eg = log(approx_eg),
         svm=factor(svm),
         student_rank=factor(student_rank, levels=c("Full rank", "50% of full", "4% of full", "Teacher rank (1% of full)"), labels=c("Full rank", "50% of full", "4% of full", "1% of full")))
```

```{r}
approx_min_d = inner_join(approx_min_d, wide_min_d)
```

```{r}
ggplot(data=approx_min_d, aes(x=Aligned_avg_min_Eg, y=approx_log_eg, color=as.integer(svm), shape=student_rank)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(1, 10), breaks=c(1,10))  +
  labs(x="Empirical best log testing error (aligned init)",
       y="Simple approx. to best log test error") +
  geom_abline(aes(intercept=0, slope=1), alpha=0.5, linetype=3) +
  geom_errorbarh(aes(xmin=Aligned_ci_Eg_lo, xmax=Aligned_ci_Eg_up), height=0.05) +
  guides(shape=guide_legend(title="Empirical results", order=2), color=guide_colorbar(title="SNR", order=1)) +
  geom_point(size=2) 
```
```{r}
ggsave("../plots/paper/simple_min_test_error_approx_aligned.png")
```


```{r}
ggplot(data=approx_min_d, aes(x=Random_avg_min_Eg, y=approx_log_eg, color=as.integer(svm), shape=student_rank)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(1, 10), breaks=c(1,10))  +
  labs(x="Empirical best log testing error (random init)",
       y="Simple approx. to best log test error") +
  geom_abline(aes(intercept=0, slope=1), alpha=0.5, linetype=3) +
  geom_errorbarh(aes(xmin=Random_ci_Eg_lo, xmax=Random_ci_Eg_up), height=0.05) +
  guides(shape=guide_legend(title="Empirical results", order=2), color=guide_colorbar(title="SNR", order=1)) +
  geom_point(size=2) 
```
```{r}
ggsave("../plots/paper/simple_min_test_error_approx_random.png")
```



# Transfer 

```{r}
nruns = 10
noise_vars = c(1.)
output_sizes= c(100)
qs = c(1, 0.95, 0.9, 0.5, 0)
svm1s = c(100, 10, 4, 1)
svm2s = c(100, 10, 4, 1)
alignments = c("True")
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (q in qs) {
      for (svm1 in svm1s) {
        for (svm2 in svm2s) {
          for (aligned in alignments) {
            for (run in 0:(nruns-1)) { 
              this_d = read.csv(sprintf("../transfer_results_2/noise_var_%.2f_output_size_%i_q_%f_svm1_%f_svm2_%f_aligned_%s_run_%i_.csv",noise_var, output_size, q, svm1, svm2, aligned, run), header=T)
        
              this_d = this_d %>% 
                mutate(noise_var=noise_var, output_size=output_size, q=q, svm1=svm1, svm2=svm2, aligned=aligned=="True", run=run, student_rank="Full rank", type="Empirical")
              d = bind_rows(d, this_d)
            }
          }
          # this_d = read.csv(sprintf("../single_generalization_comparison_results/noise_var_%.2f_svm_%f_theory_track.csv", noise_var, svm), header=T)
          # 
          # this_d = this_d %>% 
          #   rename(loss=generalization_error) %>%
          #   mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA, student_rank="Full rank", type="Theory")
          # d = bind_rows(d, this_d)
        }
      }
    }
  }
}

```

```{r}
d = d %>% 
  mutate(q = factor(q),
         svm1 = factor(svm1),
         svm2 = factor(svm2),
         aligned=factor(aligned),
         type=factor(type),
         sep_loss=symm_ben + norm_loss,
         t1_alone_loss = t1_ben + t1_jcl,
         t2_alone_loss = t2_ben + t2_jcl)
```

```{r}
avg_d = d %>%
  gather(j_or_s, loss, norm_loss, sep_loss) %>%
  mutate(loss = log(loss),
         j_or_s = ifelse(grepl("norm", j_or_s), "Joint", "Separate")) %>%
  group_by(q, svm1, svm2, aligned, j_or_s, type, noise_var, epoch) %>%
  summarize(avg_l = mean(loss),
            sd_l = sd(loss)) %>%
  ungroup()
```


```{r}
ggplot(data=avg_d %>% filter(epoch %% 100 == 0), aes(x = epoch/1000, y = avg_l, color=q, shape=j_or_s)) + 
  geom_point(size=2)  + 
  labs(y = "Average log loss (both tasks)", x="Time") +
  facet_grid(svm1~svm2) +
  scale_color_brewer(palette="BuPu") +
  scale_x_continuous(breaks=c(0, 2.5, 5)) +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  guides(shape=guide_legend(title="Training"), color=guide_legend(title="q"))
```

```{r}
ggsave("../plots/paper/transfer_learning_curves.png", width=10, height=10)
```

```{r}
t1_avg_d = d %>%
  gather(j_or_s, loss, t1_jcl, t1_alone_loss) %>%
  mutate(loss = log(loss),
         j_or_s = ifelse(grepl("jcl", j_or_s), "Joint", "Separate")) %>%
  group_by(q, svm1, svm2, aligned, j_or_s, type, noise_var, epoch) %>%
  summarize(avg_l = mean(loss),
            sd_l = sd(loss)) %>%
  ungroup()
```


```{r}
ggplot(data=t1_avg_d %>% filter(epoch %% 100 == 0), aes(x = epoch/1000, y = avg_l, color=q, shape=j_or_s)) + 
  geom_point(size=2)  + 
  labs(y = "Average log task 1 loss", x="Time") +
  facet_grid(svm1~svm2) +
  scale_color_brewer(palette="BuPu") +
  scale_x_continuous(breaks=c(0, 2.5, 5)) +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  guides(shape=guide_legend(title="Training"), color=guide_legend(title="q"))
```

```{r}
ggsave("../plots/paper/transfer_learning_curves_t1.png", width=10, height=10)
```

```{r}
benefit_d = d %>%
  mutate(jll = log(norm_loss),
         sll = log(sep_loss)) %>%
  group_by(q, svm1, svm2, aligned, type, noise_var, run) %>%
  summarize(min_jll = min(jll),
            min_sll = min(sll)) %>%
  ungroup() %>%
  mutate(benefit=min_sll-min_jll) %>%
  group_by(q, svm1, svm2, aligned, type, noise_var) %>%
  summarize(avg_benefit = mean(benefit),
            sd_benefit = sd(benefit),
            ci_upper = avg_benefit + 1.96*sd_benefit/sqrt(n()),
            ci_lower =avg_benefit - 1.96*sd_benefit/sqrt(n())) %>%
  ungroup()
```


 
```{r}
this_plot = (ggplot(data=benefit_d, aes(x = q, y = avg_benefit, color=q)) + 
  geom_point(size=2)  + 
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.5) +
  labs(y = "Benefit to optimal stopping error") +
  facet_grid(svm1 ~svm2) +
  scale_color_manual(values=c("#9EBCDA", "#8C96C6", "#8C6BB1", "#88419D", "#4D004B") ) +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  geom_hline(aes(yintercept=0), linetype=3, alpha=0.5) +
  guides(shape=guide_legend(title="Training"), color=guide_legend(title="q"))) %>% 
  label_facets(., "SNR 2", "SNR 1")
```

```{r}
ggsave("../plots/paper/transfer_benefit_to_optimal_stopping_error.png", plot=this_plot, width=10, height=10)
```

```{r}
t1_benefit_d = d %>%
  mutate(jll = log(t1_jcl),
         sll = log(t1_alone_loss)) %>%
  group_by(q, svm1, svm2, aligned, type, noise_var, run) %>%
  summarize(min_jll = min(jll),
            min_sll = min(sll)) %>%
  ungroup() %>%
  mutate(benefit=min_sll-min_jll) %>%
  group_by(q, svm1, svm2, aligned, type, noise_var) %>%
  summarize(avg_benefit = mean(benefit),
            sd_benefit = sd(benefit),
            ci_upper = avg_benefit + 1.96*sd_benefit/sqrt(n()),
            ci_lower =avg_benefit - 1.96*sd_benefit/sqrt(n())) %>%
  ungroup()
```


 
```{r}
this_plot = (ggplot(data=t1_benefit_d, aes(x = q, y = avg_benefit, color=q)) + 
  geom_point(size=2)  + 
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.5) +
  labs(y = "Benefit to optimal stopping error (task 1)") +
  facet_grid(svm1 ~svm2) +
  scale_color_manual(values=c("#9EBCDA", "#8C96C6", "#8C6BB1", "#88419D", "#4D004B") ) +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  geom_hline(aes(yintercept=0), linetype=3, alpha=0.5) +
  guides(shape=guide_legend(title="Training"), color=guide_legend(title="q"))) %>% 
  label_facets(., "SNR 2", "SNR 1")
```

```{r}
ggsave("../plots/paper/transfer_benefit_to_optimal_stopping_error_t1.png", plot=this_plot, width=10, height=10)
```

```{r}
avg_d2 = d %>% 
  mutate(benefit = log(sep_loss) - log(norm_loss)) %>% 
  group_by(q, svm1, svm2, epoch) %>%
  summarize(avg_benefit = mean(benefit))
```

```{r}
ggplot(data=avg_d2 %>% filter(epoch %% 100 == 0), aes(x = epoch/1000, y = avg_benefit, color=q)) + 
  geom_point(size=2)  + 
  labs(y = "Average benefit (log-scaled)", x="Time") +
  scale_x_continuous(breaks=c(0, 2.5, 5)) +
  facet_grid(svm1~svm2) +
  scale_color_manual(values=c("#9EBCDA", "#8C96C6", "#8C6BB1", "#88419D", "#4D004B") ) +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  guides(shape=guide_legend(title="Training"), color=guide_legend(title="q"))
```

```{r}
ggsave("../plots/paper/transfer_benefit_curves.png", width=10, height=10)
```


# fewer (gaussian) inputs


```{r}
nruns = 10
noise_vars = c(1.)
output_sizes= c(50)
svms = c(0.84, 2, 6, 10, 100)
num_inputss = c(100, 50, 20, 4)
alignments = c("True", "False")
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (num_inputs in num_inputss) {
      for (svm in svms) {
        for (aligned in alignments) {
          for (run in 0:(nruns-1)) { 
            this_d = read.csv(sprintf("../fewer_inputs_results/noise_var_%.2f_output_size_%i_num_inputs_%i_svm_%f_aligned_%s_run_%i.csv",noise_var, output_size, num_inputs, svm, aligned, run), header=T)
      
            this_d = this_d %>% 
              mutate(noise_var=noise_var, output_size=output_size, svm=svm, num_inputs, aligned=aligned=="True", run=run, student_rank="Full rank", type="Empirical")
            d = bind_rows(d, this_d)
          }
        }
        # this_d = read.csv(sprintf("../single_generalization_comparison_results/noise_var_%.2f_svm_%f_theory_track.csv", noise_var, svm), header=T)
        # 
        # this_d = this_d %>% 
        #   rename(loss=generalization_error) %>%
        #   mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA, student_rank="Full rank", type="Theory")
        # d = bind_rows(d, this_d)
      }
    }
  }
}
```

```{r}
d = d %>% 
  mutate(
    num_inputs = factor(num_inputs, levels=c(4, 20, 50, 100), labels = c("4%", "20%", "50%", "100%")),
    log_loss = log(loss)
  )
```

```{r}
avg_d = d %>%
  group_by(aligned, svm, num_inputs, type, epoch) %>%
  summarize(mean_loss = mean(log_loss, na.rm=T), sd_loss = sd(log_loss, na.rm=T)) %>% 
  ungroup()
```

```{r}
ggplot(data=avg_d %>% filter(epoch %% 20==0, svm < 100, !aligned, mean_loss < 5.), aes(x=epoch/1000, y= mean_loss, color=svm)) + 
  geom_point() +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 10), breaks=c(0.84, 10), labels=c( parse(text="sqrt(1/2, 4)"), "10      ")) +
  facet_wrap(~num_inputs) +
  labs(x=TeX("$t/\\tau$"), y=TeX("$\\ln\\, \\epsilon_{test}$")) +
  guides(color=guide_colorbar(title="SNR")) + 
  ylim(-5, 5) #+
  #xlim(0, 500)
```

```{r}
ggsave("../plots/paper/supp_fewer_inputs.png", width=5, height=5)
```



# Figure 3
 
```{r}
nruns = 10
noise_vars = c(1.)
output_sizes= c(50)
svms = c(0.84, 2., 4., 6., 8., 10.)
alignments = c("True", "False")
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (svm in svms) {
      for (aligned in alignments) {
        for (run in 0:(nruns-1)) { 
          this_d = read.csv(sprintf("../single_generalization_paper_results/noise_var_%.2f_output_size_%i_svm_%f_aligned_%s_run_%i.csv",noise_var, output_size, svm, aligned, run), header=T)
    
          this_d = this_d %>% 
            mutate(noise_var=noise_var, output_size=output_size, svm=svm, aligned=aligned=="True", run=run, student_rank="Full rank", type="Empirical")
          d = bind_rows(d, this_d)
        }
      }
      this_d = read.csv(sprintf("../single_generalization_paper_results/noise_var_%.2f_svm_%f_theory_track.csv", noise_var, svm), header=T)
    
      this_d = this_d %>% 
        rename(loss=generalization_error) %>%
        mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA, student_rank="Full rank", type="Theory")
      d = bind_rows(d, this_d)
    }
  }
}
```



```{r}
d = d %>%
  mutate(output_size=factor(output_size),
         train_loss=ifelse(type=="Theory", train_error, train_loss),
         noise_var=factor(noise_var),
         svm=factor(svm),
         aligned=factor(aligned),
         type=factor(type),
         student_rank=factor(student_rank, levels=c("Full rank", "50% of full", "4% of full", "Teacher rank (1% of full)"), labels=c("Full rank", "50% of full", "4% of full", "1% of full")),
         log_loss = log(loss),
         log_train_loss = log(train_loss))
```

```{r}
min_d = d %>%
  group_by(svm, aligned, noise_var, type, student_rank, run) %>%
  summarize(min_Eg = min(log_loss), min_t = which.min(log_loss)) %>%
  ungroup() %>%
  group_by(svm, aligned, noise_var, student_rank, type) %>%
  summarize(avg_min_Eg = mean(min_Eg), sd_min_Eg = sd(min_Eg),
            avg_min_t = mean(min_t), sd_min_t = sd(min_t),
            se_min_Eg = sd_min_Eg/sqrt(n()), ci_Eg_up= avg_min_Eg + 1.96*se_min_Eg, ci_Eg_lo= avg_min_Eg - 1.96*se_min_Eg,
            se_min_t = sd_min_t/sqrt(n()), ci_t_up= avg_min_t + 1.96*se_min_t, ci_t_lo= avg_min_t - 1.96*se_min_t) %>%
  ungroup()
  
```

```{r}
avg_d = d %>%
  group_by(noise_var, output_size, svm, aligned, epoch, student_rank, type) %>%
  summarize(loss=mean(loss), log_tr_loss_sd=sd(log_train_loss), log_tr_loss=mean(log_train_loss), log_loss_sd=sd(log_loss), log_loss=mean(log_loss)) %>%
  mutate(log_loss_95_low=log_loss-1.96*log_loss_sd/sqrt(n()), log_loss_95_high=log_loss+1.96*log_loss_sd/sqrt(n()),
         log_tr_loss_95_low=log_tr_loss-1.96*log_tr_loss_sd/sqrt(n()), log_tr_loss_95_high=log_tr_loss+1.96*log_tr_loss_sd/sqrt(n())) %>%
  ungroup() %>%
  mutate(new_type = ifelse(type == "Theory", "Theory",
                            ifelse(aligned == "TRUE", "Empirical aligned", "Empirical random"))) %>%
  mutate(new_type = factor(new_type, levels=c("Theory", "Empirical aligned", "Empirical random")),
         aligned=factor(aligned, levels=c("TRUE", "FALSE"), labels=c("TA", "Random")))
```

```{r}
p = ggplot(avg_d %>% filter(type=="Theory", svm %in% c(10, 6, 2, 0.84)), aes(x=epoch/1000, y=log_tr_loss, color=as.numeric(levels(svm)[svm]), group=interaction(new_type, svm, student_rank))) +
 geom_line(aes(linetype=factor("Theory")), size=2) +
  geom_point(data=avg_d %>% filter(grepl("Empirical", type), svm %in% c(10, 6, 2, 0.84), epoch %% 200 == 0), aes(shape=aligned), size=2) +
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_x_continuous(breaks=c(0., 5., 10.)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 10), breaks=c(0.84, 10), labels=c( parse(text="sqrt(1/2, 4)"), "10      ")) +
  labs(x=TeX("$t/\\tau$"),
       y=TeX("$\\ln \\, \\epsilon_{train}$")) +
  guides(color=F, linetype=F, shape=F)+
  annotation_custom(textGrob(label = "A", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) 


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/fig_3a.png", plot=gt, width=3, height=3)
```


```{r}
p = ggplot(avg_d %>% filter(type=="Theory", svm %in% c(10, 6, 2, 0.84)), aes(x=epoch/1000, y=log_loss, color=as.numeric(levels(svm)[svm]), group=interaction(new_type, svm, student_rank))) +
 geom_line(aes(linetype=factor("Theory")), size=2) +
  geom_point(data=avg_d %>% filter(grepl("Empirical", type), svm %in% c(10, 6, 2, 0.84), epoch %% 200 == 0), aes(shape=aligned), size=2) +
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 10), breaks=c(0.84, 10), labels=c( parse(text="sqrt(1/2, 4)"), "10      ")) +
  scale_x_continuous(breaks=c(0., 5., 10.)) +
  labs(x=TeX("$t/\\tau$"),
       y=TeX("$\\ln \\, \\epsilon_{test}$")) +
  guides(color=guide_colorbar(title="SNR", order=3), linetype=guide_legend(title="", order=1), shape=guide_legend(title="Empirical", order=2))+
  annotation_custom(textGrob(label = "B", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      )  +
  theme(legend.margin = margin(-0.1,0,-0.1,0, unit="cm"))


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/fig_3b.png", plot=gt, width=4, height=3)
```

```{r}
wide_min_d = min_d %>% 
  filter(type == "Empirical") %>%
  select(-type, -se_min_Eg, -se_min_t) %>%
  gather(metric, measurement, avg_min_Eg, sd_min_Eg, avg_min_t, sd_min_t, ci_t_up, ci_t_lo, ci_Eg_up, ci_Eg_lo) %>%
  mutate(aligned = ifelse(aligned=="TRUE", "Aligned", "Random")) %>%
  unite(am, aligned, metric) %>%
  spread(am, measurement) 
```

```{r}
p = ggplot(data=wide_min_d, aes(x=Aligned_avg_min_Eg, y=Random_avg_min_Eg, color=as.numeric(svm))) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 10), breaks=c(0.84, 5, 10), labels=c(parse(text="1/sqrt(A, 4)"), "5 ", "10"))  +
  geom_abline(intercept=0, slope=1, alpha=0.5, linetype=3) +
  labs(x=TeX("$\\min \\, \\ln \\,\\epsilon_{test}$ (TA)"),
       y=TeX("$\\min \\, \\ln \\,\\epsilon_{test}$ (Rand.)   ")) +
  geom_errorbar(aes(ymin=Random_ci_Eg_lo, ymax=Random_ci_Eg_up), width=0.05) +
  geom_errorbarh(aes(xmin=Aligned_ci_Eg_lo, xmax=Aligned_ci_Eg_up), height=0.05) +
  geom_point(size=2) +
  guides(color=F, shape=F)  +
  annotation_custom(textGrob(label = "C", hjust = 2.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.97, "npc")),
      ) 

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/fig_3c.png", plot=gt, width=3, height=3)
```

```{r}

```


```{r}
p = ggplot(data=wide_min_d, aes(x=Aligned_avg_min_t/1000, y=Random_avg_min_t/1000, color=as.integer(svm))) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 10), breaks=c(0.84, 5, 10), labels=c(parse(text="sqrt(A, 4)"), "5   ", "10  "))  +
  geom_line(aes(linetype=factor("Theory")), size=2, alpha=0) +  # haaaaacky
  geom_abline(aes(intercept=0, slope=1), alpha=0.5, linetype=3) +
  labs(x=TeX("$t_{opt}/\\tau$ (TA)"),
       y=TeX("$t_{opt}/\\tau$ (Rand.)")) +
  geom_point(aes(shape=factor("Empirical")), size=2) +
  geom_errorbar(aes(ymin=Random_ci_t_lo/1000, ymax=Random_ci_t_up/1000), width=0.01) +
  geom_errorbarh(aes(xmin=Aligned_ci_t_lo/1000, xmax=Aligned_ci_t_up/1000), height=0.01) +
  guides(color=guide_colorbar(title="SNR", order=1),
         linetype=guide_legend(title="", order=2, override.aes=list(alpha=c(1), linetype=c("solid"))),
         shape=guide_legend(title=""), order=3) +
  annotation_custom(textGrob(label = "D", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) + 
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/fig_3d.png", plot=gt,  width=4, height=3)
```

## fig 3 E
```{r}
dapprox = data.frame()
As = c(0.25, 0.5, 0.75, 1.0)

for (A in As) {
  this_d = read.csv(sprintf("../single_generalization_paper_results/A_%f_min_gen_approx.csv", A), header=T) %>%
    mutate(A=A)
  dapprox = bind_rows(dapprox, this_d)
}
```

```{r}
p = ggplot(data=dapprox %>% filter(A==0.5), aes(x=singular_value_multiplier, y=log(approx_opt_test_error))) +
  labs(x = "SNR",
       y=TeX("$\\min \\, \\ln \\,\\epsilon_{test}$ (TA)")) +
  geom_line(aes(linetype=factor("Non-neural\nOptimum")), size=2, color="#41AB5D") +
  geom_point(data=wide_min_d %>% mutate(A=factor(0.5)), aes(shape=factor("Neural\nOptimum"), x=as.numeric(levels(svm)[svm]), y=Aligned_avg_min_Eg), size=3, color="#41AB5D") + 
 # geom_errorbar(data=wide_min_d %>% mutate(A=factor(0.5)), aes(x=as.numeric(levels(svm)[svm]), y=Aligned_avg_min_Eg, ymin=Aligned_ci_Eg_lo, ymax=Aligned_ci_Eg_up), width=0.5) +
  geom_vline(xintercept=0.84, size=2, linetype=3, alpha=0.5) +
  scale_x_continuous(breaks=c(0.84, 10), labels=c( parse(text="sqrt(1/2, 4)"), "10")) +
  guides(linetype=guide_legend(title="", order=2),
         shape=guide_legend(title="", order=3))+
  annotation_custom(textGrob(label = "E", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) + 
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/fig_3e.png", plot=gt, width=4, height=3)
```

# Fig 5(?) -- transfer results

```{r}
nruns = 10
noise_vars = c(1.)
output_sizes= c(50)
qs = seq(0, 1, 0.1)
svm1s = c(100, 30, 10, 3, 0.84)
svm2s = c(100,  30, 10, 3, 0.84)
alignments = c("True")
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (q in qs) {
      for (svm1 in svm1s) {
        for (svm2 in svm2s) {
          for (aligned in alignments) {
            for (run in 0:(nruns-1)) { 
              this_d = read.csv(sprintf("../paper_transfer_results/noise_var_%.2f_output_size_%i_q_%f_svm1_%f_svm2_%f_aligned_%s_run_%i_.csv",noise_var, output_size, q, svm1, svm2, aligned, run), header=T)
        
              this_d = this_d %>% 
                mutate(noise_var=noise_var, output_size=output_size, q=q, svm1=svm1, svm2=svm2, aligned=aligned=="True", run=run, student_rank="Full rank", type="Empirical")
              d = bind_rows(d, this_d)
            }
          }
          # this_d = read.csv(sprintf("../paper_transfer_results/noise_var_%.2f_svm_%f_theory_track.csv", noise_var, svm), header=T)
          # 
          # this_d = this_d %>% 
          #   rename(loss=generalization_error) %>%
          #   mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA, student_rank="Full rank", type="Theory")
          # d = bind_rows(d, this_d)
        }
      }
    }
  }
}

```

```{r}
d = d %>% 
  mutate(svm1 = factor(svm1),
         svm2 = factor(svm2),
         aligned=factor(aligned),
         type=factor(type),
         sep_loss=symm_ben + norm_loss,
         t1_alone_loss = t1_ben + t1_jcl,
         t2_alone_loss = t2_ben + t2_jcl)
```

```{r}
symm_benefit_d = d %>%
  filter(svm1 == svm2) %>%
  mutate(svm=as.numeric(levels(svm1)[svm1])) %>%
  mutate(jll = log(norm_loss),
         sll = log(sep_loss)) %>%
  group_by(q, svm, aligned, type, noise_var, run) %>%
  summarize(min_jll = min(jll),
            min_sll = min(sll)) %>%
  ungroup() %>%
  mutate(benefit=min_sll-min_jll) %>%
  group_by(q, svm, aligned, type, noise_var) %>%
  summarize(avg_benefit = mean(benefit),
            sd_benefit = sd(benefit),
            ci_upper = avg_benefit + 1.96*sd_benefit/sqrt(n()),
            ci_lower =avg_benefit - 1.96*sd_benefit/sqrt(n())) %>%
  ungroup()
```

```{r}
# overlap = function(s, A) {
#   if (s <= A^0.25) {
#     return (0)
#   }
#   s2 = s^2
#   res =sqrt(1- ((A*(1+s2))/(s2*(A+s2)))) *sqrt(1- ((A+s2)/(s2*(1+s2))))
#   return(res)
# }
# 
# overlap=Vectorize(overlap)
```

```{r}
# benefit_theory = function(s_A, s_B, q, A) {
#   s1_joint = sqrt(s_A^2 + s_B^2 + 2*s_A *s_B*q)
#   q_prime = (s_A+q*s_B)/s1_joint
#   O_sep = overlap(s_A, A)
#   O_joint = overlap(s1_joint, A)
#   return((O_joint * q_prime) - (O_sep)^2)
# }
# 
# benefit_theory=Vectorize(benefit_theory)
```
 
```{r}
p = ggplot(data=symm_benefit_d, aes(x = q, y = avg_benefit, color=log(svm))) + 
  geom_point(aes(shape=factor("Empirical")),size=2)  + 
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.05) +
  labs(y = TeX("$(\\epsilon^{1,2}_{sep} - \\epsilon^{1,2}_{joint})/||\\bar{Y}||^2_2$"),
       x= TeX("$q$")) +
  scale_x_continuous(breaks=c(0., 0.5, 1.)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(log(0.84)-0.5, log(100)), 
                       breaks=c(log(0.84), log(10), log(100)),
                       labels=c(parse(text="sqrt(A,4)"), 10, 100))  +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  geom_hline(yintercept=0, linetype=3, alpha=0.5) +
  guides(shape=guide_legend(title=""), color=guide_colorbar(title="SNR", order=1))  +
  annotation_custom(textGrob(label = "A", hjust = 3.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) +
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt) 
```
```{r}
#ggsave("../plots/paper/fig_5a.png",plot=gt, width=4,height=3)
```

```{r}
t1_benefit_d = d %>%
  mutate(jll = (t1_jcl),
         sll = (t1_alone_loss)) %>%
  group_by(q, svm1, svm2, aligned, type, noise_var, run) %>%
  summarize(min_jll = min(jll),
            min_sll = min(sll)) %>%
  ungroup() %>%
  mutate(benefit=min_sll-min_jll) %>%
  group_by(q, svm1, svm2, aligned, type, noise_var) %>%
  summarize(avg_benefit = mean(benefit),
            sd_benefit = sd(benefit),
            ci_upper = avg_benefit + 1.96*sd_benefit/sqrt(n()),
            ci_lower =avg_benefit - 1.96*sd_benefit/sqrt(n())) %>%
  ungroup() %>%
  mutate(svm1=as.numeric(levels(svm1)[svm1]),
         svm2=as.numeric(levels(svm2)[svm2]))
```

```{r}
# ggplot(data=t1_benefit_d %>% filter(svm1 == 0.84), aes(x=benefit_theory, y=avg_benefit, color=factor(svm2)))+
#   geom_point()
```

```{r}
p = ggplot(data=t1_benefit_d %>% filter(svm1==100), aes(x = q, y = avg_benefit, color=log(svm2))) + 
  geom_point(aes(shape=factor("Empirical")),size=2)  + 
  geom_line(aes(group=svm2)) +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.05) +
  labs(y = TeX("$T^{A \\leftarrow B}$"),
       x= TeX("$q$")) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(log(0.84)-0.5, log(100)), 
                       breaks=c(log(0.84), log(10), log(100)),
                       labels=c(parse(text="sqrt(A,4)"), 10, 100))  +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  scale_x_continuous(breaks=c(0., 0.5, 1.)) +
  scale_y_continuous(breaks=c(-1e-4, 0, 1e-4), labels=c(TeX("-10^{-4}"), 0, TeX("10^{-4}"))) +
  geom_hline(yintercept=0, linetype=3, alpha=0.5) +
  guides(shape=guide_legend(title=""), color=guide_colorbar(title=TeX("\\bar{s}_B"), order=1))  +
  annotation_custom(textGrob(label = "C", hjust = 3.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) +
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt) 
```
```{r}
ggsave("../plots/paper/fig_5c.png",plot=gt, width=4,height=3)
```

```{r}
p = ggplot(data=t1_benefit_d %>% filter(svm1==0.84), aes(x = q, y = avg_benefit, color=log(svm2))) + 
  geom_point(aes(shape=factor("Empirical")),size=2)  + 
  geom_line(aes(group=svm2)) +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.05) +
  labs(y = TeX("$T^{A \\leftarrow B}$"),
       x= TeX("$q$")) +
  scale_x_continuous(breaks=c(0., 0.5, 1.)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(log(0.84)-0.5, log(100)), 
                       breaks=c(log(0.84), log(10), log(100)),
                       labels=c(parse(text="sqrt(A,4)"), 10, 100))  +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  geom_hline(yintercept=0, linetype=3, alpha=0.5) +
  guides(shape=F, color=F) +
  annotation_custom(textGrob(label = "A", hjust = 3.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) +
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt) 
```
```{r}
ggsave("../plots/paper/fig_5a.png",plot=gt, width=3,height=3)
```

```{r}
p = ggplot(data=t1_benefit_d %>% filter(svm1==3), aes(x = q, y = avg_benefit, color=log(svm2))) + 
  geom_point(aes(shape=factor("Empirical")),size=2)  + 
  geom_line(aes(group=svm2)) +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.05) +
  labs(y = TeX("$T^{A \\leftarrow B}$"),
       x= TeX("$q$")) +
  scale_x_continuous(breaks=c(0., 0.5, 1.)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(log(0.84)-0.5, log(100)), 
                       breaks=c(log(0.84), log(10), log(100)),
                       labels=c(parse(text="sqrt(A,4)"), 10, 100))  +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  geom_hline(yintercept=0, linetype=3, alpha=0.5) +
  guides(shape=F, color=F) +
  annotation_custom(textGrob(label = "B", hjust = 3.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) +
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt) 
```
```{r}
ggsave("../plots/paper/fig_5b.png",plot=gt, width=3,height=3)
```
# Fig 7(?) -- nonlinear transfer results

```{r}
nruns = 10
noise_vars = c(0.01)
output_sizes= c(50)
qs = seq(0, 1, 0.2)
svm1s = c(0.33, 0.5, 0.84, 3, 100)
svm2s = c(0.84, 3, 10, 30, 100)
alignments = c("False")
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (q in qs) {
      for (svm1 in svm1s) {
        for (svm2 in svm2s) {
          for (aligned in alignments) {
            for (run in 0:(nruns-1)) { 
              this_d = read.csv(sprintf("../paper_nonlinear_transfer_results/noise_var_%.2f_output_size_%i_q_%f_svm1_%f_svm2_%f_aligned_%s_run_%i_.csv",noise_var, output_size, q, svm1, svm2, aligned, run), header=T)
        
              this_d = this_d %>% 
                mutate(noise_var=noise_var, output_size=output_size, q=q, svm1=svm1, svm2=svm2, aligned=aligned=="True", run=run, student_rank="Full rank", type="Empirical")
              d = bind_rows(d, this_d)
            }
          }
          # this_d = read.csv(sprintf("../paper_transfer_results/noise_var_%.2f_svm_%f_theory_track.csv", noise_var, svm), header=T)
          # 
          # this_d = this_d %>% 
          #   rename(loss=generalization_error) %>%
          #   mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA, student_rank="Full rank", type="Theory")
          # d = bind_rows(d, this_d)
        }
      }
    }
  }
}

```

```{r}
d = d %>% 
  mutate(aligned=factor(aligned),
         type=factor(type),
         t1_jcl=loss_joint,
         t1_alone_loss = loss_sep)
```

```{r}
t1_benefit_d = d %>%
  mutate(jll = (t1_jcl),
         sll = (t1_alone_loss)) %>%
  group_by(q, svm1, svm2, aligned, type, noise_var, run) %>%
  summarize(min_jll = min(jll),
            min_sll = min(sll)) %>%
  ungroup() %>%
  mutate(benefit=min_sll-min_jll) %>%
  group_by(q, svm1, svm2, aligned, type, noise_var) %>%
  summarize(avg_benefit = mean(benefit),
            sd_benefit = sd(benefit),
            ci_upper = avg_benefit + 1.96*sd_benefit/sqrt(n()),
            ci_lower =avg_benefit - 1.96*sd_benefit/sqrt(n())) %>%
  ungroup()
```

```{r}
# ggplot(data=t1_benefit_d %>% filter(svm1 == 0.84), aes(x=benefit_theory, y=avg_benefit, color=factor(svm2)))+
#   geom_point()
```

```{r}
p = ggplot(data=t1_benefit_d %>% filter(svm1==100), aes(x = q, y = avg_benefit, color=log(svm2))) + 
  geom_point(aes(shape=factor("Empirical")),size=2)  + 
  geom_line(aes(group=svm2)) +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.05) +
  labs(y = TeX("$T^{A \\leftarrow B}$"),
       x= TeX("$q$")) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(log(0.84)-0.5, log(100)), 
                       breaks=c(log(0.84), log(10), log(100)),
                       labels=c(parse(text="sqrt(A,4)"), 10, 100))  +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  scale_x_continuous(breaks=c(0., 0.5, 1.)) +
  scale_y_continuous(breaks=c(-5e-4, 0, 3e-4), labels=c(TeX("-5*10^{-4}"), 0, TeX("3*10^{-4}"))) +
  geom_hline(yintercept=0, linetype=3, alpha=0.5) +
  guides(shape=guide_legend(title=""), color=guide_colorbar(title=TeX("\\bar{s}_B"), order=1))  +
  annotation_custom(textGrob(label = "C", hjust = 3.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) +
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt) 
```
```{r}
ggsave("../plots/paper/fig_7c.png",plot=gt, width=4.5,height=3)
```

```{r}
p = ggplot(data=t1_benefit_d %>% filter(svm1==0.84), aes(x = q, y = avg_benefit, color=log(svm2))) + 
  geom_point(aes(shape=factor("Empirical")),size=2)  + 
  geom_line(aes(group=svm2)) +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.05) +
  labs(y = TeX("$T^{A \\leftarrow B}$"),
       x= TeX("$q$")) +
  scale_x_continuous(breaks=c(0., 0.5, 1.)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(log(0.84)-0.5, log(100)), 
                       breaks=c(log(0.84), log(10), log(100)),
                       labels=c(parse(text="sqrt(A,4)"), 10, 100))  +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  geom_hline(yintercept=0, linetype=3, alpha=0.5) +
  guides(shape=F, color=F) +
  annotation_custom(textGrob(label = "A", hjust = 3.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) +
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt) 
```
```{r}
ggsave("../plots/paper/fig_7a.png",plot=gt, width=3,height=3)
```

```{r}
p = ggplot(data=t1_benefit_d %>% filter(svm1==3), aes(x = q, y = avg_benefit, color=log(svm2))) + 
  geom_point(aes(shape=factor("Empirical")),size=2)  + 
  geom_line(aes(group=svm2)) +
  geom_errorbar(aes(ymin=ci_lower, ymax=ci_upper), width=0.05) +
  labs(y = TeX("$T^{A \\leftarrow B}$"),
       x= TeX("$q$")) +
  scale_x_continuous(breaks=c(0., 0.5, 1.)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(log(0.84)-0.5, log(100)), 
                       breaks=c(log(0.84), log(10), log(100)),
                       labels=c(parse(text="sqrt(A,4)"), 10, 100))  +
#  scale_color_gradient(low="#770077", high="#00AA00", limits=c(0, 1))  +
  geom_hline(yintercept=0, linetype=3, alpha=0.5) +
  guides(shape=F, color=F) +
  annotation_custom(textGrob(label = "B", hjust = 3.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) +
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt) 
```
```{r}
ggsave("../plots/paper/fig_7b.png",plot=gt, width=3,height=3)
```


# Supp - inputs don't matter

```{r}
nruns = 10
noise_vars = c(0., 0.025, 0.05, 0.1, 0.2)
output_sizes= c(10, 50, 100, 200, 400)
input_types = c("one_hot", "ortho", "gauss")
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (input_type in input_types) {
      for (run in 0:(nruns-1)) { 
        if (input_type == "one_hot") {
          this_d = read.csv(sprintf("../single_generalization_results/noise_var_%.2f_output_size_%i_run_%i.csv", noise_var, output_size, run), header=T)
        } else {
          this_d = read.csv(sprintf("../single_generalization_%s_inputs_results/noise_var_%.2f_output_size_%i_run_%i.csv", input_type, noise_var, output_size, run), header=T)
        }
        this_d = this_d %>% 
          mutate(noise_var=noise_var, output_size=output_size, run=run, input_type=input_type)
        d = bind_rows(d, this_d)
      }
    }
  }
}
```

```{r}
d = d %>%
  mutate(output_size=factor(output_size),
         sigma_z=10 * sqrt(noise_var),
         SNR=4/sigma_z,
         input_type=factor(input_type, levels=c("one_hot", "gauss", "ortho"), labels=c("One-hot", "Random Gaussian", "Random orthonormal")),
         noise_var=factor(noise_var),
         log_loss = log(loss))
```

```{r}
avg_d = d %>%
  group_by(SNR, output_size, epoch, input_type) %>%
  summarize(loss=mean(loss), log_loss_sd=sd(log_loss), log_loss=mean(log_loss)) %>%
  mutate(log_loss_95_low=log_loss-1.96*log_loss_sd/sqrt(n()), log_loss_95_high=log_loss+1.96*log_loss_sd/sqrt(n())) %>%
  ungroup() %>%
  mutate(SNR=ifelse(is.infinite(SNR), 10, SNR))
```


```{r}
ggplot(avg_d %>% filter(output_size == 100, epoch %% 100 == 0), aes(x=epoch/1000, y=log_loss, color=SNR, shape=input_type, group=interaction(factor(SNR), input_type))) +
  geom_point(size=1.5) +
  scale_color_gradient(low="#0000FF", high="#FF0000") + 
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  labs(x=TeX("$t/\\tau$"), y=TeX("$\\ln\\, \\epsilon_{test}$")) +
  guides(color=guide_colorbar(title="SNR"), shape=guide_legend(title="Input type")) 
```

```{r}
ggsave("../plots/paper/supp_input_types_dont_matter.png", width=6, height=4)
```

# Supp nonlinear Figure 3AB
 
```{r}
nruns = 1
noise_vars = c(1.)
output_sizes= c(50)
svms = c(1.33, 2., 3.)
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (svm in svms) {
      for (run in 0:(nruns-1)) { 
        this_d = read.csv(sprintf("../paper_nonlinear_deep_rank3_results/noise_var_%.2f_output_size_%i_svm_%f_run_%i_.csv",noise_var, output_size, svm, run), header=T)
  
        this_d = this_d %>% 
          mutate(noise_var=noise_var, output_size=output_size, svm=svm, aligned="FALSE", run=run, student_rank="Full rank", type="Empirical")
        d = bind_rows(d, this_d)
      }
    }
    # this_d = read.csv(sprintf("../single_generalization_paper_results/noise_var_%.2f_svm_%f_theory_track.csv", noise_var, svm), header=T)
    # 
    # this_d = this_d %>% 
    #   rename(loss=generalization_error) %>%
    #   mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA, student_rank="Full rank", type="Theory")
    # d = bind_rows(d, this_d)
  }
}
```



```{r}
d = d %>%
  mutate(output_size=factor(output_size),
         train_loss=ifelse(type=="Theory", train_error, train_loss),
         noise_var=factor(noise_var),
         svm=factor(svm),
         aligned=factor(aligned),
         type=factor(type),
         log_loss = log(loss),
         log_train_loss = log(train_loss))
```

```{r}
min_d = d %>%
  group_by(svm, aligned, noise_var, type, student_rank, run) %>%
  summarize(min_Eg = min(log_loss), min_t = which.min(log_loss)) %>%
  ungroup() %>%
  group_by(svm, aligned, noise_var, student_rank, type) %>%
  summarize(avg_min_Eg = mean(min_Eg), sd_min_Eg = sd(min_Eg),
            avg_min_t = mean(min_t), sd_min_t = sd(min_t),
            se_min_Eg = sd_min_Eg/sqrt(n()), ci_Eg_up= avg_min_Eg + 1.96*se_min_Eg, ci_Eg_lo= avg_min_Eg - 1.96*se_min_Eg,
            se_min_t = sd_min_t/sqrt(n()), ci_t_up= avg_min_t + 1.96*se_min_t, ci_t_lo= avg_min_t - 1.96*se_min_t) %>%
  ungroup()
  
```

```{r}
avg_d = d %>%
  group_by(noise_var, output_size, svm, aligned, epoch, student_rank, type) %>%
  summarize(loss=mean(loss), log_tr_loss_sd=sd(log_train_loss), log_tr_loss=mean(log_train_loss), log_loss_sd=sd(log_loss), log_loss=mean(log_loss)) %>%
  mutate(log_loss_95_low=log_loss-1.96*log_loss_sd/sqrt(n()), log_loss_95_high=log_loss+1.96*log_loss_sd/sqrt(n()),
         log_tr_loss_95_low=log_tr_loss-1.96*log_tr_loss_sd/sqrt(n()), log_tr_loss_95_high=log_tr_loss+1.96*log_tr_loss_sd/sqrt(n())) %>%
  ungroup() %>%
  mutate(new_type = ifelse(type == "Theory", "Theory",
                            ifelse(aligned == "TRUE", "Empirical aligned", "Empirical random"))) %>%
  mutate(new_type = factor(new_type, levels=c("Theory", "Empirical aligned", "Empirical random")),
         aligned=factor(aligned, levels=c("TRUE", "FALSE"), labels=c("TA", "Random")))
```

```{r}
p = ggplot(data=avg_d %>% filter(grepl("Empirical", type), epoch %% 200 == 0, epoch < 1e5), aes(x=epoch/1000, y=log_tr_loss, color=as.numeric(levels(svm)[svm]), group=interaction(new_type, svm, student_rank))) +
  geom_point(aes(shape=aligned), size=2) +
 geom_line( size=0.5) +
  geom_errorbar(aes(ymin=log_tr_loss_95_low, ymax=log_tr_loss_95_high)) +
  scale_x_continuous(breaks=c(0., 75., 150.)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 4), breaks=c(0.84, 4), labels=c( parse(text="sqrt(1/2, 4)"), "4      ")) +
  labs(x=TeX("$t/\\tau$"),
       y=TeX("$\\ln \\, \\epsilon_{train}$")) +
  guides(color=F, linetype=F, shape=F)+
  annotation_custom(textGrob(label = "E", hjust = 2.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) 


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/deep_nonlinear_A.png", plot=gt, width=3, height=3)
```


```{r}
p = ggplot(data=avg_d %>% filter(grepl("Empirical", type), epoch %% 200 == 0, epoch < 1e5), aes(x=epoch/1000, y=log_loss, color=as.numeric(levels(svm)[svm]), group=interaction(new_type, svm, student_rank))) +
 geom_line( size=0.5) +
  geom_point(aes(shape=aligned), size=2) +
  geom_errorbar(aes(ymin=log_loss_95_low, ymax=log_loss_95_high)) +
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 4), breaks=c(0.84, 4), labels=c( parse(text="sqrt(1/2, 4)"), "4       ")) +
  scale_x_continuous(breaks=c(0., 75., 150.)) +
  labs(x=TeX("$t/\\tau$"),
       y=TeX("$\\ln \\, \\epsilon_{test}$")) +
  guides(color=guide_colorbar(title="SNR", order=3), linetype=guide_legend(title="", order=1), shape=guide_legend(title="Empirical", order=2))+
  annotation_custom(textGrob(label = "F", hjust = 2.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      )  +
  theme(legend.margin = margin(-0.1,0,-0.1,0, unit="cm"))


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/deep_nonlinear_B.png", plot=gt, width=4, height=3)
```

# Rebuttal Figures
 
```{r}
nruns = 20
noise_vars = c(1.)
output_sizes= c(50)
svms = c(10., 0.84, 2., 4., 6., 8.,)
alignments = c("True", "False")
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (svm in svms) {
      for (aligned in alignments) {
        for (run in 0:(nruns-1)) { 
          this_d = read.csv(sprintf("../deep_single_generalization_paper_results/noise_var_%.2f_output_size_%i_svm_%f_aligned_%s_run_%i.csv",noise_var, output_size, svm, aligned, run), header=T)
    
          this_d = this_d %>% 
            mutate(noise_var=noise_var, output_size=output_size, svm=svm, aligned=aligned=="True", run=run, student_rank="Full rank", type="Empirical")
          d = bind_rows(d, this_d)
        }
      }
      this_d = read.csv(sprintf("../deep_single_generalization_paper_results/noise_var_%.2f_p_100_svm_%f_theory_track.csv", noise_var, svm), header=T)

      this_d = this_d %>%
        rename(loss=generalization_error) %>%
        mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA, student_rank="Full rank", type="Theory")
      d = bind_rows(d, this_d)
    }
  }
}
```



```{r}
d = d %>%
  mutate(output_size=factor(output_size),
         train_loss=ifelse(type=="Theory", train_error, train_loss),
         noise_var=factor(noise_var),
         svm=factor(svm),
         aligned=factor(aligned),
         type=factor(type),
         student_rank=factor(student_rank, levels=c("Full rank", "50% of full", "4% of full", "Teacher rank (1% of full)"), labels=c("Full rank", "50% of full", "4% of full", "1% of full")),
         log_loss = log(loss),
         log_train_loss = log(train_loss))
```

```{r}
min_d = d %>%
  group_by(svm, aligned, noise_var, type, student_rank, run) %>%
  summarize(min_Eg = min(log_loss), min_t = which.min(log_loss)) %>%
  ungroup() %>%
  group_by(svm, aligned, noise_var, student_rank, type) %>%
  summarize(avg_min_Eg = mean(min_Eg), sd_min_Eg = sd(min_Eg),
            avg_min_t = mean(min_t), sd_min_t = sd(min_t),
            se_min_Eg = sd_min_Eg/sqrt(n()), ci_Eg_up= avg_min_Eg + 1.96*se_min_Eg, ci_Eg_lo= avg_min_Eg - 1.96*se_min_Eg,
            se_min_t = sd_min_t/sqrt(n()), ci_t_up= avg_min_t + 1.96*se_min_t, ci_t_lo= avg_min_t - 1.96*se_min_t) %>%
  ungroup()
  
```

```{r}
avg_d = d %>%
  group_by(noise_var, output_size, svm, aligned, epoch, student_rank, type) %>%
  summarize(loss=mean(loss), log_tr_loss_sd=sd(log_train_loss), log_tr_loss=mean(log_train_loss), log_loss_sd=sd(log_loss), log_loss=mean(log_loss)) %>%
  mutate(log_loss_95_low=log_loss-1.96*log_loss_sd/sqrt(n()), log_loss_95_high=log_loss+1.96*log_loss_sd/sqrt(n()),
         log_tr_loss_95_low=log_tr_loss-1.96*log_tr_loss_sd/sqrt(n()), log_tr_loss_95_high=log_tr_loss+1.96*log_tr_loss_sd/sqrt(n())) %>%
  ungroup() %>%
  mutate(new_type = ifelse(type == "Theory", "Theory",
                            ifelse(aligned == "TRUE", "Empirical aligned", "Empirical random"))) %>%
  mutate(new_type = factor(new_type, levels=c("Theory", "Empirical aligned", "Empirical random")),
         aligned=factor(aligned, levels=c("TRUE", "FALSE"), labels=c("TA", "Random")))
```

```{r}
p = ggplot(avg_d %>% filter(type=="Theory", svm %in% c(10, 6, 2, 0.84)), aes(x=epoch/1000, y=log_tr_loss, color=as.numeric(levels(svm)[svm]), group=interaction(new_type, svm, student_rank))) +
 geom_line(aes(linetype=factor("Theory")), size=1.5) +
  geom_point(data=avg_d %>% filter(grepl("Empirical", type), svm %in% c(10, 6, 2, 0.84), aligned=="TA", epoch %% 1000 == 0), aes(shape=aligned), size=2) +
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_x_continuous(breaks=c(0., 75., 150.)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 10), breaks=c(0.84, 10), labels=c( parse(text="sqrt(1/2, 4)"), "10      ")) +
  labs(x=TeX("$t/\\tau$"),
       y=TeX("$\\ln \\, \\epsilon_{train}$")) +
  guides(color=F, linetype=F, shape=F)+
  annotation_custom(textGrob(label = "A", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) 


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/rebuttal_a.png", plot=gt, width=3, height=3)
```


```{r}
p = ggplot(avg_d %>% filter(type=="Theory", svm %in% c(10, 6, 2, 0.84), epoch %% 1000 == 1), aes(x=epoch/1000, y=log_loss, color=as.numeric(levels(svm)[svm]), group=interaction(new_type, svm, student_rank))) +
 geom_line(aes(linetype=factor("Theory")), size=1.5) +
  geom_point(data=avg_d %>% filter(grepl("Empirical", type), svm %in% c(10, 6, 2, 0.84), aligned=="TA", epoch %% 500 == 0), aes(shape=aligned), size=2) +
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 10), breaks=c(0.84, 10), labels=c( parse(text="sqrt(1/2, 4)"), "10      ")) +
  scale_x_continuous(breaks=c(0., 75., 150.)) +
  labs(x=TeX("$t/\\tau$"),
       y=TeX("$\\ln \\, \\epsilon_{test}$")) +
  guides(color=guide_colorbar(title="SNR", order=3), linetype=guide_legend(title="", order=1), shape=guide_legend(title="Empirical", order=2))+
  annotation_custom(textGrob(label = "B", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      )  +
  theme(legend.margin = margin(-0.1,0,-0.1,0, unit="cm"))


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/rebuttal_b.png", plot=gt, width=4, height=3)
```

```{r}
wide_min_d = min_d %>% 
  filter(type == "Empirical") %>%
  select(-type, -se_min_Eg, -se_min_t) %>%
  gather(metric, measurement, avg_min_Eg, sd_min_Eg, avg_min_t, sd_min_t, ci_t_up, ci_t_lo, ci_Eg_up, ci_Eg_lo) %>%
  mutate(aligned = ifelse(aligned=="TRUE", "Aligned", "Random")) %>%
  unite(am, aligned, metric) %>%
  spread(am, measurement) 
```

```{r}
p = ggplot(data=wide_min_d, aes(x=Aligned_avg_min_Eg, y=Random_avg_min_Eg, color=as.numeric(svm))) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 10), breaks=c(0.84, 5, 10), labels=c(parse(text="1/sqrt(A, 4)"), "5 ", "10"))  +
  geom_abline(intercept=0, slope=1, alpha=0.5, linetype=3) +
  labs(x=TeX("$\\min \\, \\ln \\,\\epsilon_{test}$ (TA)"),
       y=TeX("$\\min \\, \\ln \\,\\epsilon_{test}$ (Rand.)   ")) +
  geom_errorbar(aes(ymin=Random_ci_Eg_lo, ymax=Random_ci_Eg_up), width=0.05) +
  geom_errorbarh(aes(xmin=Aligned_ci_Eg_lo, xmax=Aligned_ci_Eg_up), height=0.05) +
  geom_point(size=2) +
  guides(color=F, shape=F)  +
  annotation_custom(textGrob(label = "C", hjust = 2.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.97, "npc")),
      ) 

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/rebuttal_c.png", plot=gt, width=3, height=3)
```

```{r}

```


```{r}
p = ggplot(data=wide_min_d, aes(x=Aligned_avg_min_t/1000, y=Random_avg_min_t/1000, color=as.integer(svm))) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 10), breaks=c(0.84, 5, 10), labels=c(parse(text="sqrt(A, 4)"), "5   ", "10  "))  +
  geom_line(aes(linetype=factor("Theory")), size=2, alpha=0) +  # haaaaacky
  geom_abline(aes(intercept=0, slope=1), alpha=0.5, linetype=3) +
  labs(x=TeX("$t_{opt}/\\tau$ (TA)"),
       y=TeX("$t_{opt}/\\tau$ (Rand.)")) +
  geom_point(aes(shape=factor("Empirical")), size=2) +
  geom_errorbar(aes(ymin=Random_ci_t_lo/1000, ymax=Random_ci_t_up/1000), width=0.01) +
  geom_errorbarh(aes(xmin=Aligned_ci_t_lo/1000, xmax=Aligned_ci_t_up/1000), height=0.01) +
  guides(color=guide_colorbar(title="SNR", order=1),
         linetype=guide_legend(title="", order=2, override.aes=list(alpha=c(1), linetype=c("solid"))),
         shape=guide_legend(title=""), order=3) +
  annotation_custom(textGrob(label = "D", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) + 
  theme(legend.margin = margin(-0.25,0,-0.25,0, unit="cm"))


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
#ggsave("../plots/paper/rebuttal_d.png", plot=gt,  width=4, height=3)
```

# Deep rank 3 figures
 
```{r}
nruns = 10
noise_vars = c(1.)
output_sizes= c(50)
svms = c(1.33, 2., 3.)
alignments = c("True", "False")
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (svm in svms) {
      for (aligned in alignments) {
        for (run in 0:(nruns-1)) { 
          this_d = read.csv(sprintf("../deep_rank3_single_generalization_paper_results/noise_var_%.2f_output_size_%i_svm_%f_aligned_%s_run_%i.csv",noise_var, output_size, svm, aligned, run), header=T)
    
          this_d = this_d %>% 
            mutate(noise_var=noise_var, output_size=output_size, svm=svm, aligned=aligned=="True", run=run, student_rank="Full rank", type="Empirical")
          d = bind_rows(d, this_d)
        }
      }
      this_d = read.csv(sprintf("../deep_rank3_single_generalization_paper_results/noise_var_%.2f_p_100_svm_%f_theory_track.csv", noise_var, svm), header=T)

      this_d = this_d %>%
        rename(loss=generalization_error) %>%
        mutate(noise_var=noise_var, output_size=NA,  svm=svm, aligned=aligned=="True", run=NA, student_rank="Full rank", type="Theory")
      d = bind_rows(d, this_d)
    }
  }
}
```



```{r}
d = d %>%
  mutate(output_size=factor(output_size),
         train_loss=ifelse(type=="Theory", train_error, train_loss),
         noise_var=factor(noise_var),
         svm=factor(svm),
         aligned=factor(aligned),
         type=factor(type),
         student_rank=factor(student_rank, levels=c("Full rank", "50% of full", "4% of full", "Teacher rank (1% of full)"), labels=c("Full rank", "50% of full", "4% of full", "1% of full")),
         log_loss = log(loss),
         log_train_loss = log(train_loss))
```

```{r}
min_d = d %>%
  group_by(svm, aligned, noise_var, type, student_rank, run) %>%
  summarize(min_Eg = min(log_loss), min_t = which.min(log_loss)) %>%
  ungroup() %>%
  group_by(svm, aligned, noise_var, student_rank, type) %>%
  summarize(avg_min_Eg = mean(min_Eg), sd_min_Eg = sd(min_Eg),
            avg_min_t = mean(min_t), sd_min_t = sd(min_t),
            se_min_Eg = sd_min_Eg/sqrt(n()), ci_Eg_up= avg_min_Eg + 1.96*se_min_Eg, ci_Eg_lo= avg_min_Eg - 1.96*se_min_Eg,
            se_min_t = sd_min_t/sqrt(n()), ci_t_up= avg_min_t + 1.96*se_min_t, ci_t_lo= avg_min_t - 1.96*se_min_t) %>%
  ungroup()
  
```

```{r}
avg_d = d %>%
  group_by(noise_var, output_size, svm, aligned, epoch, student_rank, type) %>%
  summarize(loss=mean(loss), log_tr_loss_sd=sd(log_train_loss), log_tr_loss=mean(log_train_loss), log_loss_sd=sd(log_loss), log_loss=mean(log_loss)) %>%
  mutate(log_loss_95_low=log_loss-1.96*log_loss_sd/sqrt(n()), log_loss_95_high=log_loss+1.96*log_loss_sd/sqrt(n()),
         log_tr_loss_95_low=log_tr_loss-1.96*log_tr_loss_sd/sqrt(n()), log_tr_loss_95_high=log_tr_loss+1.96*log_tr_loss_sd/sqrt(n())) %>%
  ungroup() %>%
  mutate(new_type = ifelse(type == "Theory", "Theory",
                            ifelse(aligned == "TRUE", "Empirical aligned", "Empirical random"))) %>%
  mutate(new_type = factor(new_type, levels=c("Theory", "Empirical aligned", "Empirical random")),
         aligned=factor(aligned, levels=c("TRUE", "FALSE"), labels=c("TA", "Random")))
```

```{r}
p = ggplot(avg_d %>% filter(type=="Theory"), aes(x=epoch/1000, y=log_tr_loss, color=as.numeric(levels(svm)[svm]), group=interaction(new_type, svm, student_rank))) +
 geom_line(aes(linetype=factor("Theory")), size=1.5) +
  geom_point(data=avg_d %>% filter(grepl("Empirical", type), aligned=="TA", epoch %% 200 == 0), aes(shape=aligned), size=2) +
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_x_continuous(breaks=c(0., 75., 150.)) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 4), breaks=c(0.84, 4), labels=c( parse(text="sqrt(1/2, 4)"), "4      ")) +
  labs(x=TeX("$t/\\tau$"),
       y=TeX("$\\ln \\, \\epsilon_{train}$")) +
  guides(color=F, linetype=F, shape=F)+
  annotation_custom(textGrob(label = "A", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) 


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/deep_a.png", plot=gt, width=3, height=3)
```


```{r}
p = ggplot(avg_d %>% filter(type=="Theory", epoch %% 1000 == 1), aes(x=epoch/1000, y=log_loss, color=as.numeric(levels(svm)[svm]), group=interaction(new_type, svm, student_rank))) +
 geom_line(aes(linetype=factor("Theory")), size=1.5) +
  geom_point(data=avg_d %>% filter(grepl("Empirical", type), aligned=="TA", epoch %% 200 == 0), aes(shape=aligned), size=2) +
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 4), breaks=c(0.84, 4), labels=c( parse(text="sqrt(1/2, 4)"), "4      ")) +
  scale_x_continuous(breaks=c(0., 75., 150.)) +
  labs(x=TeX("$t/\\tau$"),
       y=TeX("$\\ln \\, \\epsilon_{test}$")) +
  guides(color=guide_colorbar(title="min SNR", order=3), linetype=guide_legend(title="", order=1), shape=guide_legend(title="Empirical", order=2))+
  annotation_custom(textGrob(label = "B", hjust = 2.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      )  +
  theme(legend.margin = margin(-0.1,0,-0.1,0, unit="cm"))


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/deep_b.png", plot=gt, width=4, height=3)
```


```{r}
wide_min_d = min_d %>% 
  filter(type == "Empirical") %>%
  select(-type, -se_min_Eg, -se_min_t) %>%
  gather(metric, measurement, avg_min_Eg, sd_min_Eg, avg_min_t, sd_min_t, ci_t_up, ci_t_lo, ci_Eg_up, ci_Eg_lo) %>%
  mutate(aligned = ifelse(aligned=="TRUE", "Aligned", "Random")) %>%
  unite(am, aligned, metric) %>%
  spread(am, measurement) 
```

```{r}
p = ggplot(data=wide_min_d, aes(x=Aligned_avg_min_Eg, y=Random_avg_min_Eg, color=as.numeric(svm))) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 4), breaks=c(0.84, 4), labels=c(parse(text="1/sqrt(A, 4)"), "4 "))  +
  geom_abline(intercept=0, slope=1, alpha=0.5, linetype=3) +
  labs(x=TeX("$\\min \\, \\ln \\,\\epsilon_{test}$ (TA)"),
       y=TeX("$\\min \\, \\ln \\,\\epsilon_{test}$ (Rand.)   ")) +
  geom_errorbar(aes(ymin=Random_ci_Eg_lo, ymax=Random_ci_Eg_up), width=0.05) +
  geom_errorbarh(aes(xmin=Aligned_ci_Eg_lo, xmax=Aligned_ci_Eg_up), height=0.05) +
  geom_point(size=2) +
  guides(color=F, shape=F)  +
  annotation_custom(textGrob(label = "C", hjust = 2.5, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.97, "npc")),
      ) 

gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/deep_c.png", plot=gt, width=3, height=3)
```

```{r}
p = ggplot(data=wide_min_d, aes(x=Aligned_avg_min_t/1000, y=Random_avg_min_t/1000, color=as.integer(svm))) +
  scale_color_gradient(low="#0000FF", high="#FF0000", limits=c(0, 4), breaks=c(0.84, 4), labels=c(parse(text="1/sqrt(A, 4)"), "4 "))  +
  geom_abline(aes(intercept=0, slope=1), alpha=0.5, linetype=3) +
  labs(x=TeX("$t_{opt}/\\tau$ (TA)"),
       y=TeX("$t_{opt}/\\tau$ (Rand.)")) +
  geom_point(aes(shape=factor("Empirical")), size=2) +
  geom_errorbar(aes(ymin=Random_ci_t_lo/1000, ymax=Random_ci_t_up/1000), width=0.3) +
  geom_errorbarh(aes(xmin=Aligned_ci_t_lo/1000, xmax=Aligned_ci_t_up/1000), height=0.3) +
  xlim(4, 12) +
  ylim(4, 12) +
  guides(color=guide_colorbar(title="SNR", order=1),
         shape=F) +
  annotation_custom(textGrob(label = "D", hjust = 3, gp = gpar(cex = 2),
      x=unit(0, "npc"), y=unit(0.95, "npc")),
      ) + 
  theme(legend.margin = margin(-1,0,-0.25,0, unit="cm"))


gt <- ggplot_gtable(ggplot_build(p))
gt$layout$clip[gt$layout$name == "panel"] <- "off"
grid.draw(gt)
```

```{r}
ggsave("../plots/paper/deep_d.png", plot=gt,  width=4, height=3)
```
