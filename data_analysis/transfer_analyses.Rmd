---
title: "transfer analyses"
author: "Andrew Lampinen"
date: "October 31, 2017"
output: html_document
---

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r}
theme_set(theme_bw() +
            theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))
```

```{r}
nruns = 2
ndoms = c(2)
qs = c(1, 0.5, 0, -0.5, -1)
d = data.frame()
for (ndom in ndoms) {
  for (q in qs) {
    for (run in 0:(nruns-1)) {
      this_d = read.csv(sprintf("../correlation_results/loss_ndom%i_correlation%f_run%i.csv", ndom, q, run), header=T)
      this_d = this_d %>% 
        mutate(ndom=ndom, q=q, run=run)
      d = bind_rows(d, this_d)
    }
  }
}
```

```{r}
d = d %>%
  mutate(loss_per = loss/ndom,
         log_loss_per = log(loss_per),
         ndom=factor(ndom, levels=c(1,2,4,10)),
         abs_q = factor(abs(q)),
         q = factor(q),
         log_loss = log(loss))
```

```{r}
avg_d = d %>%
  group_by(q, abs_q, ndom, epoch) %>%
  summarize(loss=mean(loss), log_loss=mean(log_loss), loss_per=mean(loss_per), log_loss_per=mean(log_loss_per))
```


```{r}
ggplot(avg_d %>% filter(ndom==2), aes(x=epoch, y=log_loss_per, color=q)) +
  geom_line(size=1.5) +
  scale_color_brewer(palette='BuPu') + 
  theme_bw()
```

```{r}
ggsave("../plots/correlation_first_results.png")
```

```{r}
ggplot(avg_d %>% filter(ndom == 2), aes(x=epoch, y=log_loss, color=q)) +
  geom_line(size=1.5) +
  scale_color_brewer(palette='BuPu') + 
  ylim(-2.1, -2.0) +
  theme_bw()
```

```{r}
ggsave("../plots/correlation_first_results_zoomed_in.png")
```

```{r}
ggplot(avg_d %>% filter(q==0), aes(x=epoch, y=log_loss_per, color=ndom)) +
  geom_line(size=1.5) +
  scale_color_brewer(palette='BuPu', drop=F) + 
  theme_bw()
```
```{r}
ggsave("../plots/q0_ndom_comparison.png")
```

```{r}
ggplot(avg_d %>% filter(q==1), aes(x=epoch, y=log_loss_per, color=ndom)) +
  geom_line(size=1.5) +
  scale_color_brewer(palette='BuPu', drop=F) + 
  theme_bw()
```
```{r}
ggsave("../plots/q1_ndom_comparison.png")
```

# Orthogonal


```{r}
nruns = 10
ndoms = c(1, 2, 4, 10)
d = data.frame()
for (ndom in ndoms) {
  for (q in qs) {
    for (run in 0:(nruns-1)) {
      this_d = read.csv(sprintf("../orthogonal_transform_results/loss_ndom%i_run%i.csv", ndom, run), header=T)
      this_d = this_d %>% 
        mutate(ndom=ndom, run=run)
      d = bind_rows(d, this_d)
    }
  }
}
```

```{r}
d = d %>%
  mutate(loss_per=loss/ndom,
         ndom=factor(ndom),
         log_loss_per=log(loss_per),
         log_loss = log(loss))
```

```{r}
avg_d = d %>%
  group_by(ndom, epoch) %>%
  summarize(loss=mean(loss), log_loss=mean(log_loss), loss_per=mean(loss_per), log_loss_per=mean(log_loss_per))
```


```{r}
ggplot(avg_d, aes(x=epoch, y=log_loss_per, color=ndom)) +
  geom_line(size=1.2) +
  scale_color_brewer(palette='BuPu') + 
  theme_bw()
```
```{r}
ggsave("../plots/orthogonal_first_results.png")
```

# Eight things

```{r}
nruns = 10
features_types = c('original', 'scrambled')
d = data.frame()
for (features in features_types) {
  for (q in qs) {
    for (run in 0:(nruns-1)) {
      this_d = read.csv(sprintf("../eightthings_smallweights_results/loss_features%s_run%i.csv", features, run), header=T)
      this_d = this_d %>% 
        mutate(features=features, run=run)
      d = bind_rows(d, this_d)
    }
  }
}
```

```{r}
d = d %>%
  filter(epoch <= 1000) %>%
  mutate(features=factor(features),
         log_loss = log(loss))
```

```{r}
avg_d = d %>%
  group_by(features, epoch) %>%
  summarize(loss=mean(loss), log_loss=mean(log_loss))
```


```{r}
ggplot(avg_d, aes(x=epoch, y=log_loss, color=features)) +
  geom_line(size=1.2) +
  scale_color_brewer(palette='BuPu') + 
  theme_bw()
```
```{r}
ggsave("../plots/eightthings_slower_results.png")
```


# Eight things (with label noise)

```{r}
nruns = 50
features_types = c('original', 'scrambled')
d = data.frame()
for (features in features_types) {
  for (q in qs) {
    for (run in 0:(nruns-1)) {
      this_d = read.csv(sprintf("../eightthings_noisy_results/loss_features%s_run%i.csv", features, run), header=T)
      this_d = this_d %>% 
        mutate(features=features, run=run)
      d = bind_rows(d, this_d)
    }
  }
}
```

```{r}
d = d %>%
  filter(epoch <= 1000) %>%
  mutate(features=factor(features),
         log_loss = log(loss))
```

```{r}
avg_d = d %>%
  group_by(features, epoch) %>%
  summarize(loss=mean(loss), log_loss_sd=sd(log_loss), log_loss=mean(log_loss)) %>%
  mutate(log_loss_95_low=log_loss-1.96*log_loss_sd/sqrt(n()), log_loss_95_high=log_loss+1.96*log_loss_sd/sqrt(n())) %>%
  ungroup() %>%
  mutate(features=factor(features, labels=c("Shared structure", "No shared structure")))
```


```{r}
ggplot(avg_d, aes(x=epoch, y=log_loss, color=features)) +
  geom_line(size=1.2) +
  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_color_manual(values=c("#B3CDE3", "#88419D")) + 
  scale_fill_manual(values=c("#B3CDE3", "#88419D")) + 
  theme_bw()
```
```{r}
ggsave("../plots/eightthings_noisy_results.png")
```

# Shared input modes analysis

```{r}
nruns = 10
qs = c(0, 0.2, 0.39, 0.79, 1.57, 3.14)
num_domains = c(2, 10)
d = data.frame()
for (num_dom in num_domains) {
  for (q in qs) {
    for (run in 0:(nruns-1)) {
      this_d = read.csv(sprintf("../shared_input_mode_batch_results/loss_ndom%i_q%.2f_run%i.csv", num_dom, q, run), header=T)
      this_d = this_d %>% 
        mutate(q=q, num_domains=num_dom, run=run)
      d = bind_rows(d, this_d)
    }
  }
}
```

```{r}
d = d %>%
  filter(q < 3.14) %>%
  mutate(q=factor(q),
         num_domains=factor(num_domains),
         log_loss = log(loss))
```

```{r}
avg_d = d %>%
  group_by(q, num_domains, epoch) %>%
  summarize(loss=mean(loss), log_loss_sd=sd(log_loss), log_loss=mean(log_loss)) %>%
  mutate(log_loss_95_low=log_loss-1.96*log_loss_sd/sqrt(n()), log_loss_95_high=log_loss+1.96*log_loss_sd/sqrt(n())) %>%
  ungroup()
```


```{r}
ggplot(avg_d %>% filter(epoch < 2000), aes(x=epoch, y=log_loss, color=q)) +
  geom_line(size=1.2) +
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_color_brewer(palette="BuPu") + 
  ylab("Log generalization loss") +
  xlab("Epoch") +
  guides(color=guide_legend(title=bquote(phi))) +
  facet_wrap(~ num_domains) 
```
```{r}
ggsave("../plots/shared_input_modes_batch_results.png")
```


# Single domain generalization analyses

```{r}
nruns = 10
noise_vars = c(0., 0.025, 0.05, 0.1, 0.2)
output_sizes= c(10, 50, 100, 200, 400)
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (run in 0:(nruns-1)) {
      this_d = read.csv(sprintf("../single_generalization_results/noise_var_%.2f_output_size_%i_run_%i.csv", noise_var, output_size, run), header=T)
      this_d = this_d %>% 
        mutate(noise_var=noise_var, output_size=output_size, run=run)
      d = bind_rows(d, this_d)
    }
  }
}
```

```{r}
d = d %>%
  mutate(output_size=factor(output_size),
         noise_var=factor(noise_var),
         log_loss = log(loss))
```

```{r}
avg_d = d %>%
  group_by(noise_var, output_size, epoch) %>%
  summarize(loss=mean(loss), log_loss_sd=sd(log_loss), log_loss=mean(log_loss)) %>%
  mutate(log_loss_95_low=log_loss-1.96*log_loss_sd/sqrt(n()), log_loss_95_high=log_loss+1.96*log_loss_sd/sqrt(n())) %>%
  ungroup()
```


```{r}
ggplot(avg_d %>% filter(output_size != 400), aes(x=epoch, y=log_loss, color=noise_var)) +
  geom_line(size=1.2) +
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_color_brewer(palette="YlOrRd") + 
  ylab("Log generalization loss") +
  xlab("Epoch") +
  guides(color=guide_legend(title="Noise Variance")) +
  facet_wrap(~ output_size) 
```
```{r}
ggsave("../plots/single_domain_generalization_curves.png")
```


## comparing input types
```{r}
nruns = 10
noise_vars = c(0., 0.025, 0.05, 0.1, 0.2)
output_sizes= c(10, 50, 100, 200, 400)
input_types = c("one_hot", "ortho", "gauss")
d = data.frame()
for (noise_var in noise_vars) {
  for (output_size in output_sizes) {
    for (input_type in input_types) {
      for (run in 0:(nruns-1)) { 
        if (input_type == "one_hot") {
          this_d = read.csv(sprintf("../single_generalization_results/noise_var_%.2f_output_size_%i_run_%i.csv", noise_var, output_size, run), header=T)
        } else {
          this_d = read.csv(sprintf("../single_generalization_%s_inputs_results/noise_var_%.2f_output_size_%i_run_%i.csv", input_type, noise_var, output_size, run), header=T)
        }
        this_d = this_d %>% 
          mutate(noise_var=noise_var, output_size=output_size, run=run, input_type=input_type)
        d = bind_rows(d, this_d)
      }
    }
  }
}
```

```{r}
d = d %>%
  mutate(output_size=factor(output_size),
         input_type=factor(input_type, levels=c("one_hot", "gauss", "ortho"), labels=c("One-hot", "Random Gaussian", "Random orthonormal")),
         noise_var=factor(noise_var),
         log_loss = log(loss))
```

```{r}
avg_d = d %>%
  group_by(noise_var, output_size, epoch, input_type) %>%
  summarize(loss=mean(loss), log_loss_sd=sd(log_loss), log_loss=mean(log_loss)) %>%
  mutate(log_loss_95_low=log_loss-1.96*log_loss_sd/sqrt(n()), log_loss_95_high=log_loss+1.96*log_loss_sd/sqrt(n())) %>%
  ungroup()
```


```{r}
ggplot(avg_d %>% filter(output_size == 100), aes(x=epoch, y=log_loss, color=noise_var, linetype=input_type)) +
  geom_line(size=1.2) +
#  geom_ribbon(aes(ymin=log_loss_95_low, ymax=log_loss_95_high, fill=features), alpha=0.5) +
  scale_color_brewer(palette="YlOrRd") + 
  ylab("Log generalization loss") +
  xlab("Epoch") +
  guides(color=guide_legend(title="Noise Variance"), linetype=guide_legend(title="Input type")) 
```

```{r}
ggsave("../plots/input_types_dont_matter.png")
```

